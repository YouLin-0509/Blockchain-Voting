
# Blockchain Voting Project – Four‑System Technical Blueprint (v2.0)

> **Scope** — This document supersedes `technical_blueprint.md` and formalises the architecture for **four _independent_ systems** that share one core code‑base but differ in their privacy and computation strategies:

| Variant | ZKP (VeRange) | Off‑chain MPC | On‑chain tally | Purpose |
|---------|--------------|--------------|----------------|---------|
| **Base** | ✕ | ✕ | ✓ | Gas & logic baseline |
| **MPC** | ✕ | ✓ | ✕ (verify sig only) | Measure MPC benefits |
| **VeRange** | ✓ | ✕ | ✓ | Quantify ZKP gas cost |
| **MPC + VeRange** | ✓ | ✓ | ✕ | Full security target |

---

## 0. High‑level Topology

```
                ┌───────────── DApp (React + wagmi) ──────────────┐
Frontend  ─────▶│   ① Registration / Voting UI                   │
JSON‑RPC        │   ② (opt) VeRange proof generation (WebWorker) │
                └────────────────────────────────────────────────┘
                                 │
                                 ▼
                     ┌──────── EVM Chain ───────┐
                     │  VotingRouter (common)   │
                     │  ├─ Tally plugin     ◀───┼── Base / MPC
                     │  └─ Verifier plugin  ◀───┼── VeRange
                     └──────────────────────────┘
                                 │ CID / Events
                                 ▼
             (opt) Off‑chain MPC network (Docker, libp2p)
                                 │
                                 ▼
                             IPFS cluster
```

* **Router** is constant; plugins determine the variant.  
* **Front‑end** switches address & feature‑flags by `.env` (`BUILD_VARIANT=base|mpc|zk|mpc-zk`).

---

## 1. Repository Layout (after refactor)

```
contracts/
├─ common/          # Identity, BallotStorage, Errors
├─ interfaces/      # ITally.sol, IVerifier.sol
├─ plugins/
│   ├─ base/        # TallyBase.sol          (Base & VeRange)
│   ├─ mpc/         # MPCDispatcher.sol      (MPC & MPC+VeRange)
│   ├─ verange/     # Verifier.sol           (VeRange & MPC+VeRange)
│   └─ glue/        # (small adapter if both)
└─ VotingRouter.sol # single entry
scripts/
├─ deploy-base.js
├─ deploy-mpc.js
├─ deploy-zk.js
└─ deploy-mpc-zk.js
frontend/
└─ …
mpc/                # Docker compose for n MPC nodes
circuits/           # VeRange Type‑1 artefacts
docs/
└─ specs/
    └─ blueprint_four_systems.md   ◀── (this file)
```

---

## 2. Contract Matrix

| Contract | Base | MPC | VeRange | MPC + VeRange | Notes |
|----------|------|-----|---------|---------------|-------|
| **VotingRouter** | ✓ | ✓ | ✓ | ✓ | Injects plugins in constructor |
| **TallyBase** | ✓ | ✕ | ✓ | ✕ | On‑chain tally loop |
| **MPCDispatcher** | ✕ | ✓ | ✕ | ✓ | Emits `MPCTaskAssigned` & verifies agg‑sig |
| **Verifier (VeRange)** | ✕ | ✕ | ✓ | ✓ | Auto‑generated by `snarkjs` |
| **Identity / Storage** | ✓ | ✓ | ✓ | ✓ | Shared |

Gas expectations (Goerli, 7 Gwei):

| Tx | Base | MPC | VeRange | MPC+VeRange |
|----|------|-----|---------|-------------|
| `vote` / `submitBallot` | ~45 k | ~47 k | ~300 k | ~302 k |
| `tally` / `publishResult` | 350 k | ~110 k | 350 k | ~110 k |

---

## 3. Front‑end Feature Flags

| Feature | Base | MPC | VeRange | MPC + VeRange |
|---------|------|-----|---------|---------------|
| Wallet connect | ✓ | ✓ | ✓ | ✓ |
| Candidate selector | ✓ | ✓ | ✓ | ✓ |
| IPFS upload ballot | ✕ | ✓ | ✕ | ✓ |
| ZKP proof widget | ✕ | ✕ | ✓ | ✓ |
| MPC status panel | ✕ | ✓ | ✕ | ✓ |

Implementation pattern:

```tsx
if (import.meta.env.REACT_APP_BUILD_VARIANT.includes('zk')) {
  return <ProofGenerator …/>
}
```

---

## 4. Deployment Matrix

| Cmd | Network | Plugins Injected |
|-----|---------|------------------|
| `npm run dev:base` | Hardhat | TallyBase |
| `npm run dev:mpc` | Hardhat + docker‑compose | MPCDispatcher |
| `npm run dev:zk` | Hardhat | TallyBase + Verifier |
| `npm run dev:mpc-zk` | Hardhat + docker | MPCDispatcher + Verifier |

CI (GitHub Actions):

* Matrix job `{variant: [base,mpc,zk,mpc-zk]}`  
* Steps: `npm ci` → compile → deploy → replay 100 ballots → output gas CSV.

---

## 5. Test & Benchmark Plan

| Layer | Suite | Tool |
|-------|-------|------|
| Unit | `votingBase.test.js` + plugin‑spec tests | Hardhat + chai |
| E2E | Replay script (`scripts/replay.ts`) | ethers.js |
| Perf | `benchmark.ts` → CSV + matplotlib | node |
| Security | Echidna fuzz, MythX static | nightly CI |

Metrics captured:

* `gasUsed`, `runtime(ms)` per tx  
* Proof generation time (browser)  
* Network RTT & σ for MPC nodes  

---

## 6. Road‑map

| Sprint | Deliverable |
|--------|-------------|
| 1 | Merge Base refactor into `main` |
| 2 | VeRange circuits + Verifier plugin |
| 3 | Docker MPC network + Dispatcher plugin |
| 4 | Integrate MPC + VeRange & CI matrix |
| 5 | Benchmarks, paper & presentation |

Target finish: **July 2025**.

---

## 7. Future Enhancements

* BLS aggregate ring signature (batch verify).  
* Port to zk‑EVM L2 for lower gas.  
* Weighted voting & delegation (new ZK circuits).  
* Mobile wallet deep‑link & account abstraction.  

---

### Appendix A – Phase Diagram

```
Register ── addVoter ──┐
                       ▼
                     Voting ── vote/submitBallot ──┐
                                                   ▼
                                                 Ended
```

---

**Changelog**  

| Date | Rev | Notes |
|------|-----|-------|
| 2025‑06‑05 | 2.0 | First blueprint covering four variants |
